keycloak:
  image:
    repository: bitnamilegacy/keycloak
  global:
    security:
      allowInsecureImages: true
  ## @param namespaceOverride String to fully override common.names.namespace
  ##
  namespaceOverride: ""
  ## Keycloak authentication parameters
  ## ref: https://github.com/bitnami/containers/tree/main/bitnami/keycloak#admin-credentials
  ##
  auth:
    ## @param auth.adminUser Keycloak administrator user
    ##
    adminUser: admin
    ## @param auth.existingSecret Existing secret containing Keycloak admin password
    ##
    existingSecret: "keycloak-admin-postgres"
    ## @param auth.passwordSecretKey Key where the Keycloak admin password is being stored inside the existing secret.
    ##
    passwordSecretKey: "adminPassword"
  ## HTTPS settings
  ## ref: https://github.com/bitnami/containers/tree/main/bitnami/keycloak#tls-encryption
  ##
  tls:
    # Two options: auto-generated or enable the certificate below and rely on
    # the existing secret.
    enabled: true
    autoGenerated: true

    usePem: true

    # See below
    #existingSecret: keycloak-tls

  ## @param adminRealm Name of the admin realm
  ##
  adminRealm: "master"
  ## @param production Run Keycloak in production mode. TLS configuration is required except when using proxy=edge.
  ##
  production: true
  ## @param proxyHeaders Set Keycloak proxy headers
  ##
  proxyHeaders: "forwarded"
  ## @param httpRelativePath Set the path relative to '/' for serving resources. Useful if you are migrating from older version which were using '/auth/'
  ## ref: https://www.keycloak.org/migration/migrating-to-quarkus#_default_context_path_changed
  ##
  httpRelativePath: "/"

  ## Keycloak resource requests and limits
  ## ref: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/
  ## @param resourcesPreset Set container resources according to one common preset (allowed values: none, nano, micro, small, medium, large, xlarge, 2xlarge). This is ignored if resources is set (resources is recommended for production).
  ## More information: https://github.com/bitnami/charts/blob/main/bitnami/common/templates/_resources.tpl#L15
  ##
  resourcesPreset: "large"
  ## Service configuration
  ##
  service:
    ## @param service.type Kubernetes service type
    ##
    type: ClusterIP
    ## @param service.http.enabled Enable http port on service
    ##
    http:
      enabled: true

  ## Keycloak ingress parameters
  ## ref: https://kubernetes.io/docs/concepts/services-networking/ingress/
  ##
  ingress:
    ## @param ingress.enabled Enable ingress record generation for Keycloak
    ##
    enabled: true
    ## @param ingress.ingressClassName IngressClass that will be be used to implement the Ingress (Kubernetes 1.18+)
    ## This is supported in Kubernetes 1.18+ and required if you have more than one IngressClass marked as the default for your cluster .
    ## ref: https://kubernetes.io/blog/2020/04/02/improvements-to-the-ingress-api-in-kubernetes-1.18/
    ##
    ingressClassName: "nginx"
    ## @param ingress.pathType Ingress path type
    ##
    pathType: Prefix
    ## @param ingress.hostname Default host for the ingress record (evaluated as template)
    ##
    hostname: keycloak.chorus-tre.local
    ## @param ingress.path [string] Default path for the ingress record (evaluated as template)
    ##
    path: "{{ .Values.httpRelativePath }}"
    ## @param ingress.servicePort Backend service port to use
    ## Default is http. Alternative is https.
    ##
    servicePort: http
    ## @param ingress.annotations [object] Additional annotations for the Ingress resource. To enable certificate autogeneration, place here your cert-manager annotations.
    ## Use this parameter to set the required annotations for cert-manager, see
    ## ref: https://cert-manager.io/docs/usage/ingress/#supported-annotations
    ## e.g:
    ## annotations:
    ##   kubernetes.io/ingress.class: nginx
    ##   cert-manager.io/cluster-issuer: cluster-issuer-name
    ##
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    ## @param ingress.tls Enable TLS configuration for the host defined at `ingress.hostname` parameter
    ## TLS certificates will be retrieved from a TLS secret with name: `{{- printf "%s-tls" (tpl .Values.ingress.hostname .) }}`
    ## You can:
    ##   - Use the `ingress.secrets` parameter to create this TLS secret
    ##   - Rely on cert-manager to create it by setting the corresponding annotations
    ##   - Rely on Helm to create self-signed certificates by setting `ingress.selfSigned=true`
    ##
    tls: true
    ## @param ingress.selfSigned Create a TLS secret for this ingress record using self-signed certificates generated by Helm
    ##
    selfSigned: false
  ## Keycloak admin ingress parameters
  ## ref: https://kubernetes.io/docs/user-guide/ingress/
  ##
  adminIngress:
    ## @param adminIngress.enabled Enable admin ingress record generation for Keycloak
    ##
    enabled: true
    ## @param adminIngress.ingressClassName IngressClass that will be be used to implement the Ingress (Kubernetes 1.18+)
    ## This is supported in Kubernetes 1.18+ and required if you have more than one IngressClass marked as the default for your cluster .
    ## ref: https://kubernetes.io/blog/2020/04/02/improvements-to-the-ingress-api-in-kubernetes-1.18/
    ##
    ingressClassName: "nginx"
    ## @param adminIngress.pathType Ingress path type
    ##
    pathType: Prefix
    ## @param adminIngress.hostname Default host for the admin ingress record (evaluated as template)
    ##
    hostname: keycloak-admin.chorus-tre.local
    ## @param adminIngress.path [string] Default path for the admin ingress record (evaluated as template)
    ##
    path: "{{ .Values.httpRelativePath }}"
    ## @param adminIngress.servicePort Backend service port to use
    ## Default is http. Alternative is https.
    ##
    servicePort: http
    ## @param adminIngress.annotations [object] Additional annotations for the Ingress resource. To enable certificate autogeneration, place here your cert-manager annotations.
    ## Use this parameter to set the required annotations for cert-manager, see
    ## ref: https://cert-manager.io/docs/usage/ingress/#supported-annotations
    ## e.g:
    ## annotations:
    ##   kubernetes.io/ingress.class: nginx
    ##   cert-manager.io/cluster-issuer: cluster-issuer-name
    ##
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    ## @param adminIngress.tls Enable TLS configuration for the host defined at `adminIngress.hostname` parameter
    ## TLS certificates will be retrieved from a TLS secret with name: `{{- printf "%s-tls" (tpl .Values.adminIngress.hostname .) }}`
    ## You can:
    ##   - Use the `adminIngress.secrets` parameter to create this TLS secret
    ##   - Rely on cert-manager to create it by setting the corresponding annotations
    ##   - Rely on Helm to create self-signed certificates by setting `adminIngress.selfSigned=true`
    ##
    tls: true
    ## @param adminIngress.selfSigned Create a TLS secret for this ingress record using self-signed certificates generated by Helm
    ##
    selfSigned: false

  ## Configuration for keycloak-config-cli
  ## ref: https://github.com/adorsys/keycloak-config-cli
  ##
  keycloakConfigCli:
    ## @param keycloakConfigCli.enabled Whether to enable keycloak-config-cli job
    ##
    enabled: true

    ## Bitnami keycloak-config-cli image
    ## ref: https://hub.docker.com/r/bitnami/keycloak-config-cli/tags/
    ## @param keycloakConfigCli.image.registry [default: REGISTRY_NAME] keycloak-config-cli container image registry
    ## @param keycloakConfigCli.image.repository [default: REPOSITORY_NAME/keycloak-config-cli] keycloak-config-cli container image repository
    ## @skip keycloakConfigCli.image.tag keycloak-config-cli container image tag
    ## @param keycloakConfigCli.image.digest keycloak-config-cli container image digest in the way sha256:aa.... Please note this parameter, if set, will override the tag
    ## @param keycloakConfigCli.image.pullPolicy keycloak-config-cli container image pull policy
    ## @param keycloakConfigCli.image.pullSecrets keycloak-config-cli container image pull secrets
    ##
    image:
      registry: docker.io
      repository: bitnamilegacy/keycloak-config-cli
      tag: 6.4.0-debian-12-r3
      digest: ""
      ## Specify a imagePullPolicy
      ## ref: https://kubernetes.io/docs/concepts/containers/images/#pre-pulled-images
      ##
      pullPolicy: IfNotPresent

    ## @param keycloakConfigCli.annotations [object] Annotations for keycloak-config-cli job
    ## ref: https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/
    ##
    annotations:
      argocd.argoproj.io/hook: PostSync
      argocd.argoproj.io/hook-delete-policy: HookSucceeded,BeforeHookCreation

    ## @param keycloakConfigCli.backoffLimit Number of retries before considering a Job as failed
    ## ref: https://kubernetes.io/docs/concepts/workloads/controllers/job/#pod-backoff-failure-policy
    ##
    backoffLimit: 3

    ## Automatic Cleanup for Finished Jobs
    ## @param keycloakConfigCli.cleanupAfterFinished.enabled Enables Cleanup for Finished Jobs
    ## @param keycloakConfigCli.cleanupAfterFinished.seconds Sets the value of ttlSecondsAfterFinished
    ## ref: https://kubernetes.io/docs/concepts/workloads/controllers/ttlafterfinished/
    ##
    cleanupAfterFinished:
      enabled: true
      seconds: 600

    ## @param keycloakConfigCli.extraEnvVars Additional environment variables to set
    ## Example:
    ## extraEnvVars:
    ##   - name: FOO
    ##     value: "bar"
    ##
    extraEnvVars:
    - name: IMPORT_FILES_LOCATIONS
      value: /realm/*.yaml
    - name: IMPORT_VARSUBSTITUTION_ENABLED
      value: "true"
    # To make sure that imports are re-applied on every run
    - name: IMPORT_CACHE_ENABLED
      value: "false"
    # Enables remote state in encrypted format.
    # If unset, state will be stored in plain
    - name: IMPORT_REMOTESTATE_ENCRYPTIONKEY
      valueFrom:
        secretKeyRef:
          name: "keycloak-remotestate-encryption-key"
          key: encryptionKey

    ## @param keycloakConfigCli.extraEnvVarsCM ConfigMap with extra environment variables
    ##
    extraEnvVarsCM: keycloak-client-config
    ## @param keycloakConfigCli.extraEnvVarsSecret Secret with extra environment variables
    ##
    extraEnvVarsSecret: keycloak-client-secret
    ## @param keycloakConfigCli.extraVolumes Extra volumes to add to the job
    ##
    extraVolumes:
    - name: realm-config
      configMap:
        # This must match the realm-config.yaml ConfigMap
        name: keycloak-realm-config
    ## @param keycloakConfigCli.extraVolumeMounts Extra volume mounts to add to the container
    ##
    extraVolumeMounts:
    - name: realm-config
      mountPath: /realm/
      readOnly: true

  ## PostgreSQL chart configuration
  ## ref: https://github.com/bitnami/charts/blob/main/bitnami/postgresql/values.yaml
  ## @param postgresql.enabled Switch to enable or disable the PostgreSQL helm chart
  ## @param postgresql.auth.postgresPassword Password for the "postgres" admin user. Ignored if `auth.existingSecret` with key `postgres-password` is provided
  ## @param postgresql.auth.username Name for a custom user to create
  ## @param postgresql.auth.password Password for the custom user to create
  ## @param postgresql.auth.database Name for a custom database to create
  ## @param postgresql.auth.existingSecret Name of existing secret to use for PostgreSQL credentials
  ## @param postgresql.architecture PostgreSQL architecture (`standalone` or `replication`)
  ##
  postgresql:
    enabled: true
    auth:
      existingSecret: "keycloak-admin-postgres"

  ## External PostgreSQL configuration
  ## All of these values are only used when postgresql.enabled is set to false
  ## @param externalDatabase.host Database host
  ## @param externalDatabase.port Database port number
  ## @param externalDatabase.user Non-root username for Keycloak
  ## @param externalDatabase.password Password for the non-root username for Keycloak
  ## @param externalDatabase.database Keycloak database name
  ## @param externalDatabase.existingSecret Name of an existing secret resource containing the database credentials
  ## @param externalDatabase.existingSecretHostKey Name of an existing secret key containing the database host name
  ## @param externalDatabase.existingSecretPortKey Name of an existing secret key containing the database port
  ## @param externalDatabase.existingSecretUserKey Name of an existing secret key containing the database user
  ## @param externalDatabase.existingSecretDatabaseKey Name of an existing secret key containing the database name
  ## @param externalDatabase.existingSecretPasswordKey Name of an existing secret key containing the database credentials
  ## @param externalDatabase.annotations Additional custom annotations for external database secret object
  ##
  externalDatabase:
    host: ""
    port: 5432
    user: bn_keycloak
    database: bitnami_keycloak
    password: ""
    existingSecret: ""
    existingSecretHostKey: ""
    existingSecretPortKey: ""
    existingSecretUserKey: ""
    existingSecretDatabaseKey: ""
    existingSecretPasswordKey: ""
    annotations: {}

# Client configuration for various applications
# used by keycloak-config-cli to setup clients
client:
  existingSecret: keycloak-client-secret
  alertmanager:
    rootUrl: "http://alertmanager.local"
    adminUrl: "http://alertmanager.local"
    baseUrl: "/"
    redirectUris: '["http://alertmanager.local/*", "*"]'
    webOrigins: '["http://alertmanager.local", "*"]'
  grafana:
    rootUrl: "http://grafana.local"
    adminUrl: "http://grafana.local"
    baseUrl: "/"
    redirectUris: '["http://grafana.local/login/generic_oauth", "*"]'
    webOrigins: '["http://grafana.local", "*"]'
  harbor:
    rootUrl: "http://harbor.local"
    adminUrl: "http://harbor.local"
    baseUrl: "/harbor/projects"
    redirectUris: '["http://harbor.local/c/oidc/callback", "*"]'
    webOrigins: '["http://harbor.local", "*"]'
  matomo:
    rootUrl: "http://makoto.local"
    adminUrl: "http://makoto.local"
    baseUrl: "/"
    redirectUris: '["http://makoto.local/index.php?module=LoginOIDC&action=callback&provider=oidc","http://makoto.local", "*"]'
    webOrigins: '["http://makoto.local", "*"]'
  prometheus:
    rootUrl: "http://prometheus.local"
    adminUrl: "http://prometheus.local"
    baseUrl: "/"
    redirectUris: '["http://prometheus.local/*","http://alertmanager.local/*", "*"]'
    webOrigins: '["http://prometheus.local", "*"]'
  chorus:
    enabled: false
    rootUrl: "http://backend.local"
    adminUrl: "http://backend.local"
    baseUrl: "/"
    redirectUris: '["http://backend.local/*","http://chorus.local/*", "*"]'
    webOrigins: '["http://backend.local/*","http://chorus.local/*", "*"]'

certificate:
  enabled: false

  # Same as above.
  secretName: keycloak-tls

  duration: 2169h # 90d
  renewBefore: 360h # 15d

  issuerRef:
    name: CHANGEME-issuer

  priorityClassName: high-priority
